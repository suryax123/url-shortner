<%- include('../partials/header', { title: 'Earnings', chartjs: true }) %>

<div class="dashboard">
    <div class="dashboard-sidebar">
        <div class="sidebar-user">
            <% if (user.avatar) { %>
                <img src="<%= user.avatar %>" alt="" class="sidebar-avatar">
            <% } else { %>
                <div class="sidebar-avatar-placeholder">
                    <%= user.name.charAt(0).toUpperCase() %>
                </div>
            <% } %>
            <h3><%= user.name %></h3>
            <p><%= user.email %></p>
        </div>
        
        <nav class="sidebar-nav">
            <a href="/dashboard" class="sidebar-link">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>
            <a href="/dashboard/links" class="sidebar-link">
                <i class="bi bi-link-45deg"></i> My Links
            </a>
            <a href="/dashboard/earnings" class="sidebar-link active">
                <i class="bi bi-currency-dollar"></i> Earnings
            </a>
            <a href="/dashboard/withdraw" class="sidebar-link">
                <i class="bi bi-wallet2"></i> Withdraw
            </a>
            <a href="/dashboard/referral" class="sidebar-link">
                <i class="bi bi-people"></i> Referrals
            </a>
            <a href="/dashboard/settings" class="sidebar-link">
                <i class="bi bi-gear"></i> Settings
            </a>
        </nav>
    </div>
    
    <div class="dashboard-content">
        <div class="dashboard-header">
            <h1>Earnings</h1>
            <p>Track your earnings and payment history</p>
        </div>
        
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon purple">
                    <i class="bi bi-currency-dollar"></i>
                </div>
                <div class="stat-info">
                    <h3>$<%= user.totalEarnings.toFixed(2) %></h3>
                    <p>Total Earnings</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon green">
                    <i class="bi bi-wallet2"></i>
                </div>
                <div class="stat-info">
                    <h3>$<%= user.pendingEarnings.toFixed(2) %></h3>
                    <p>Available Balance</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon blue">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="stat-info">
                    <h3>$<%= user.paidEarnings.toFixed(2) %></h3>
                    <p>Total Withdrawn</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon orange">
                    <i class="bi bi-people"></i>
                </div>
                <div class="stat-info">
                    <h3>$<%= user.referralEarnings.toFixed(2) %></h3>
                    <p>Referral Earnings</p>
                </div>
            </div>
        </div>
        
        <!-- Withdraw Button -->
        <div class="card">
            <div class="card-body text-center">
                <% if (user.pendingEarnings >= 5) { %>
                    <a href="/dashboard/withdraw" class="btn btn-primary btn-lg">
                        <i class="bi bi-wallet2"></i> Withdraw $<%= user.pendingEarnings.toFixed(2) %>
                    </a>
                <% } else { %>
                    <p class="text-muted">Minimum withdrawal: $5.00</p>
                    <p>You need $<%= (5 - user.pendingEarnings).toFixed(2) %> more to withdraw</p>
                <% } %>
            </div>
        </div>
        
        <!-- Monthly Earnings Chart -->
        <div class="card">
            <div class="card-header">
                <h2><i class="bi bi-graph-up"></i> Monthly Earnings</h2>
            </div>
            <div class="card-body">
                <canvas id="earningsChart" height="300"></canvas>
            </div>
        </div>
        
        <!-- CPM Rates Info -->
        <div class="card">
            <div class="card-header">
                <h2><i class="bi bi-info-circle"></i> CPM Rates</h2>
            </div>
            <div class="card-body">
                <p>Your earnings depend on where your visitors come from. Here are the CPM rates:</p>
                <div class="cpm-tiers">
                    <div class="cpm-tier">
                        <h4>Tier 1 (100%)</h4>
                        <p>US, UK, CA, AU, DE, FR, NL, SE, NO, DK, CH, AT, BE, IE, NZ</p>
                        <span class="cpm-rate">$<%= user.cpmRate.toFixed(2) %> CPM</span>
                    </div>
                    <div class="cpm-tier">
                        <h4>Tier 2 (70%)</h4>
                        <p>IT, ES, PT, PL, CZ, GR, JP, KR, SG, HK, TW, IL, AE, SA</p>
                        <span class="cpm-rate">$<%= (user.cpmRate * 0.7).toFixed(2) %> CPM</span>
                    </div>
                    <div class="cpm-tier">
                        <h4>Tier 3 (40%)</h4>
                        <p>BR, MX, AR, CL, CO, IN, PH, TH, MY, ID, VN, TR, RU, UA, ZA</p>
                        <span class="cpm-rate">$<%= (user.cpmRate * 0.4).toFixed(2) %> CPM</span>
                    </div>
                    <div class="cpm-tier">
                        <h4>Tier 4 (20%)</h4>
                        <p>All other countries</p>
                        <span class="cpm-rate">$<%= (user.cpmRate * 0.2).toFixed(2) %> CPM</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Payment History -->
        <div class="card">
            <div class="card-header">
                <h2><i class="bi bi-clock-history"></i> Payment History</h2>
            </div>
            <div class="card-body">
                <% if (payments.length > 0) { %>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Status</th>
                                    <th>Transaction ID</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% payments.forEach(function(payment) { %>
                                    <tr>
                                        <td><%= payment.createdAt.toLocaleDateString() %></td>
                                        <td>$<%= payment.amount.toFixed(2) %></td>
                                        <td><%= payment.paymentMethod.type.toUpperCase() %></td>
                                        <td>
                                            <span class="badge badge-<%= payment.status %>">
                                                <%= payment.status %>
                                            </span>
                                        </td>
                                        <td><%= payment.transactionId || '-' %></td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } else { %>
                    <div class="empty-state">
                        <i class="bi bi-wallet2"></i>
                        <p>No payment history yet.</p>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<script>
    var monthlyEarnings = <%- JSON.stringify(monthlyEarnings) %>;
    var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    new Chart(document.getElementById('earningsChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: monthlyEarnings.map(function(m) { 
                return months[m._id.month - 1] + ' ' + m._id.year; 
            }),
            datasets: [
                {
                    label: 'Earnings ($)',
                    data: monthlyEarnings.map(function(m) { return m.earnings; }),
                    backgroundColor: '#6c5ce7'
                },
                {
                    label: 'Views',
                    data: monthlyEarnings.map(function(m) { return m.clicks; }),
                    backgroundColor: '#00cec9',
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    position: 'left',
                    title: { display: true, text: 'Earnings ($)' }
                },
                y1: {
                    beginAtZero: true,
                    position: 'right',
                    title: { display: true, text: 'Views' },
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
</script>

<%- include('../partials/footer') %>
