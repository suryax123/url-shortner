<%- include('../partials/header', { title: 'My Links' }) %>

<div class="dashboard">
    <div class="dashboard-sidebar">
        <div class="sidebar-user">
            <% if (user.avatar) { %>
                <img src="<%= user.avatar %>" alt="" class="sidebar-avatar">
            <% } else { %>
                <div class="sidebar-avatar-placeholder">
                    <%= user.name.charAt(0).toUpperCase() %>
                </div>
            <% } %>
            <h3><%= user.name %></h3>
            <p><%= user.email %></p>
        </div>
        
        <nav class="sidebar-nav">
            <a href="/dashboard" class="sidebar-link">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>
            <a href="/dashboard/links" class="sidebar-link active">
                <i class="bi bi-link-45deg"></i> My Links
            </a>
            <a href="/dashboard/earnings" class="sidebar-link">
                <i class="bi bi-currency-dollar"></i> Earnings
            </a>
            <a href="/dashboard/withdraw" class="sidebar-link">
                <i class="bi bi-wallet2"></i> Withdraw
            </a>
            <a href="/dashboard/referral" class="sidebar-link">
                <i class="bi bi-people"></i> Referrals
            </a>
            <a href="/dashboard/settings" class="sidebar-link">
                <i class="bi bi-gear"></i> Settings
            </a>
        </nav>
    </div>
    
    <div class="dashboard-content">
        <div class="dashboard-header">
            <h1>My Links</h1>
            <p>Manage all your shortened links</p>
        </div>
        
        <!-- Create Link -->
        <div class="card">
            <div class="card-header">
                <h2><i class="bi bi-plus-circle"></i> Create New Link</h2>
            </div>
            <div class="card-body">
                <form id="createLinkForm" class="create-link-form">
                    <div class="form-row">
                        <div class="form-group flex-grow">
                            <input type="url" id="originalUrl" name="originalUrl" placeholder="Paste your long URL here..." required>
                        </div>
                        <div class="form-group">
                            <input type="text" id="title" name="title" placeholder="Title (optional)">
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-lightning"></i> Shorten
                        </button>
                    </div>
                </form>
                <div id="linkResult" class="link-result hidden">
                    <div class="result-box">
                        <input type="text" id="shortUrl" readonly>
                        <button type="button" id="copyBtn" class="btn btn-secondary">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Links Table -->
        <div class="card">
            <div class="card-header">
                <h2><i class="bi bi-list"></i> All Links (<%= links.length %>)</h2>
            </div>
            <div class="card-body">
                <% if (links.length > 0) { %>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Short URL</th>
                                    <th>Original URL</th>
                                    <th>Clicks</th>
                                    <th>Earnings</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% links.forEach(function(link) { %>
                                    <tr id="link-<%= link._id %>">
                                        <td>
                                            <a href="<%= baseUrl %>/<%= link.shortId %>" target="_blank" class="short-link">
                                                <%= link.shortId %>
                                            </a>
                                        </td>
                                        <td class="original-url" title="<%= link.originalUrl %>">
                                            <%= link.originalUrl.substring(0, 50) %><%= link.originalUrl.length > 50 ? '...' : '' %>
                                        </td>
                                        <td><%= link.clicks.toLocaleString() %></td>
                                        <td>$<%= link.totalEarnings.toFixed(4) %></td>
                                        <td><%= link.createdAt.toLocaleDateString() %></td>
                                        <td>
                                            <div class="action-buttons">
                                                <button class="btn btn-sm btn-icon copy-link" data-url="<%= baseUrl %>/<%= link.shortId %>" title="Copy">
                                                    <i class="bi bi-clipboard"></i>
                                                </button>
                                                <a href="/dashboard/links/<%= link._id %>/analytics" class="btn btn-sm btn-icon" title="Analytics">
                                                    <i class="bi bi-graph-up"></i>
                                                </a>
                                                <button class="btn btn-sm btn-icon btn-danger delete-link" data-id="<%= link._id %>" title="Delete">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <% if (totalPages > 1) { %>
                        <div class="pagination">
                            <% if (currentPage > 1) { %>
                                <a href="/dashboard/links?page=<%= currentPage - 1 %>" class="btn btn-sm">&laquo; Prev</a>
                            <% } %>
                            
                            <span class="page-info">Page <%= currentPage %> of <%= totalPages %></span>
                            
                            <% if (currentPage < totalPages) { %>
                                <a href="/dashboard/links?page=<%= currentPage + 1 %>" class="btn btn-sm">Next &raquo;</a>
                            <% } %>
                        </div>
                    <% } %>
                <% } else { %>
                    <div class="empty-state">
                        <i class="bi bi-link-45deg"></i>
                        <p>No links yet. Create your first link above!</p>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<script>
    // Create link form
    document.getElementById('createLinkForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var url = document.getElementById('originalUrl').value;
        var title = document.getElementById('title').value;
        
        fetch('/dashboard/links/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ originalUrl: url, title: title })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                document.getElementById('shortUrl').value = data.shortUrl;
                document.getElementById('linkResult').classList.remove('hidden');
                setTimeout(function() {
                    window.location.reload();
                }, 1500);
            } else {
                alert(data.error || 'Failed to create link');
            }
        })
        .catch(function(err) {
            alert('Error creating link');
        });
    });
    
    // Copy buttons
    document.querySelectorAll('.copy-link').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var url = this.getAttribute('data-url');
            navigator.clipboard.writeText(url).then(function() {
                btn.innerHTML = '<i class="bi bi-check"></i>';
                setTimeout(function() {
                    btn.innerHTML = '<i class="bi bi-clipboard"></i>';
                }, 2000);
            });
        });
    });
    
    document.getElementById('copyBtn').addEventListener('click', function() {
        var shortUrl = document.getElementById('shortUrl');
        shortUrl.select();
        document.execCommand('copy');
        this.innerHTML = '<i class="bi bi-check"></i> Copied!';
        var btn = this;
        setTimeout(function() {
            btn.innerHTML = '<i class="bi bi-clipboard"></i> Copy';
        }, 2000);
    });
    
    // Delete buttons
    document.querySelectorAll('.delete-link').forEach(function(btn) {
        btn.addEventListener('click', function() {
            if (!confirm('Are you sure you want to delete this link?')) return;
            
            var id = this.getAttribute('data-id');
            fetch('/dashboard/links/' + id, {
                method: 'DELETE'
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.success) {
                    document.getElementById('link-' + id).remove();
                } else {
                    alert(data.error || 'Failed to delete link');
                }
            })
            .catch(function(err) {
                alert('Error deleting link');
            });
        });
    });
</script>

<%- include('../partials/footer') %>
