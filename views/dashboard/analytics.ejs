<%- include('../partials/header', { title: 'Link Analytics', chartjs: true }) %>

<div class="dashboard">
    <div class="dashboard-sidebar">
        <div class="sidebar-user">
            <% if (user.avatar) { %>
                <img src="<%= user.avatar %>" alt="" class="sidebar-avatar">
            <% } else { %>
                <div class="sidebar-avatar-placeholder">
                    <%= user.name.charAt(0).toUpperCase() %>
                </div>
            <% } %>
            <h3><%= user.name %></h3>
            <p><%= user.email %></p>
        </div>
        
        <nav class="sidebar-nav">
            <a href="/dashboard" class="sidebar-link">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>
            <a href="/dashboard/links" class="sidebar-link active">
                <i class="bi bi-link-45deg"></i> My Links
            </a>
            <a href="/dashboard/earnings" class="sidebar-link">
                <i class="bi bi-currency-dollar"></i> Earnings
            </a>
            <a href="/dashboard/withdraw" class="sidebar-link">
                <i class="bi bi-wallet2"></i> Withdraw
            </a>
            <a href="/dashboard/referral" class="sidebar-link">
                <i class="bi bi-people"></i> Referrals
            </a>
            <a href="/dashboard/settings" class="sidebar-link">
                <i class="bi bi-gear"></i> Settings
            </a>
        </nav>
    </div>
    
    <div class="dashboard-content">
        <div class="dashboard-header">
            <div>
                <a href="/dashboard/links" class="back-link"><i class="bi bi-arrow-left"></i> Back to Links</a>
                <h1>Link Analytics</h1>
                <p class="link-url"><%= baseUrl %>/<%= url.shortId %></p>
            </div>
        </div>
        
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">
                    <i class="bi bi-eye"></i>
                </div>
                <div class="stat-info">
                    <h3><%= url.clicks.toLocaleString() %></h3>
                    <p>Total Views</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon green">
                    <i class="bi bi-currency-dollar"></i>
                </div>
                <div class="stat-info">
                    <h3>$<%= url.totalEarnings.toFixed(4) %></h3>
                    <p>Total Earnings</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon purple">
                    <i class="bi bi-phone"></i>
                </div>
                <div class="stat-info">
                    <h3><%= url.deviceStats.mobile || 0 %></h3>
                    <p>Mobile Views</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon orange">
                    <i class="bi bi-display"></i>
                </div>
                <div class="stat-info">
                    <h3><%= url.deviceStats.desktop || 0 %></h3>
                    <p>Desktop Views</p>
                </div>
            </div>
        </div>
        
        <!-- Link Info -->
        <div class="card">
            <div class="card-header">
                <h2><i class="bi bi-info-circle"></i> Link Details</h2>
            </div>
            <div class="card-body">
                <div class="link-details">
                    <div class="detail-row">
                        <span class="label">Short URL:</span>
                        <span class="value">
                            <a href="<%= baseUrl %>/<%= url.shortId %>" target="_blank"><%= baseUrl %>/<%= url.shortId %></a>
                            <button class="btn btn-sm copy-btn" data-url="<%= baseUrl %>/<%= url.shortId %>">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Original URL:</span>
                        <span class="value"><a href="<%= url.originalUrl %>" target="_blank"><%= url.originalUrl %></a></span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Created:</span>
                        <span class="value"><%= url.createdAt.toLocaleString() %></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Charts -->
        <div class="charts-row">
            <div class="card chart-card">
                <div class="card-header">
                    <h2><i class="bi bi-graph-up"></i> Views (Last 30 Days)</h2>
                </div>
                <div class="card-body">
                    <canvas id="viewsChart"></canvas>
                </div>
            </div>
            
            <div class="card chart-card">
                <div class="card-header">
                    <h2><i class="bi bi-globe"></i> Countries</h2>
                </div>
                <div class="card-body">
                    <canvas id="countryChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="charts-row">
            <div class="card chart-card">
                <div class="card-header">
                    <h2><i class="bi bi-device-hdd"></i> Devices</h2>
                </div>
                <div class="card-body">
                    <canvas id="deviceChart"></canvas>
                </div>
            </div>
            
            <div class="card chart-card">
                <div class="card-header">
                    <h2><i class="bi bi-cash"></i> Earnings (Last 30 Days)</h2>
                </div>
                <div class="card-body">
                    <canvas id="earningsChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Country Table -->
        <div class="card">
            <div class="card-header">
                <h2><i class="bi bi-globe"></i> Views by Country</h2>
            </div>
            <div class="card-body">
                <% 
                    var countries = Object.entries(countryStats).sort(function(a, b) { return b[1] - a[1]; });
                %>
                <% if (countries.length > 0) { %>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Country</th>
                                    <th>Views</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% countries.slice(0, 10).forEach(function(c) { %>
                                    <tr>
                                        <td><%= c[0] %></td>
                                        <td><%= c[1].toLocaleString() %></td>
                                        <td><%= ((c[1] / url.clicks) * 100).toFixed(1) %>%</td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } else { %>
                    <div class="empty-state">
                        <p>No geographic data available yet.</p>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<script>
    var dailyStats = <%- JSON.stringify(dailyStats) %>;
    var countryStats = <%- JSON.stringify(countryStats) %>;
    var deviceStats = <%- JSON.stringify(url.deviceStats) %>;
    
    // Views Chart
    new Chart(document.getElementById('viewsChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: dailyStats.map(function(s) { return new Date(s.date).toLocaleDateString(); }),
            datasets: [{
                label: 'Views',
                data: dailyStats.map(function(s) { return s.clicks; }),
                borderColor: '#6c5ce7',
                backgroundColor: 'rgba(108, 92, 231, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
    
    // Country Chart
    var countryLabels = Object.keys(countryStats).slice(0, 8);
    var countryData = countryLabels.map(function(k) { return countryStats[k]; });
    
    new Chart(document.getElementById('countryChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: countryLabels,
            datasets: [{
                data: countryData,
                backgroundColor: ['#6c5ce7', '#00cec9', '#fd79a8', '#fdcb6e', '#00b894', '#e17055', '#74b9ff', '#a29bfe']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right' } }
        }
    });
    
    // Device Chart
    new Chart(document.getElementById('deviceChart').getContext('2d'), {
        type: 'pie',
        data: {
            labels: ['Desktop', 'Mobile', 'Tablet', 'Unknown'],
            datasets: [{
                data: [deviceStats.desktop || 0, deviceStats.mobile || 0, deviceStats.tablet || 0, deviceStats.unknown || 0],
                backgroundColor: ['#6c5ce7', '#00cec9', '#fd79a8', '#b2bec3']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right' } }
        }
    });
    
    // Earnings Chart
    new Chart(document.getElementById('earningsChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: dailyStats.map(function(s) { return new Date(s.date).toLocaleDateString(); }),
            datasets: [{
                label: 'Earnings ($)',
                data: dailyStats.map(function(s) { return s.earnings; }),
                backgroundColor: '#00b894'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
    
    // Copy button
    document.querySelectorAll('.copy-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var url = this.getAttribute('data-url');
            navigator.clipboard.writeText(url).then(function() {
                btn.innerHTML = '<i class="bi bi-check"></i>';
                setTimeout(function() {
                    btn.innerHTML = '<i class="bi bi-clipboard"></i>';
                }, 2000);
            });
        });
    });
</script>

<%- include('../partials/footer') %>
