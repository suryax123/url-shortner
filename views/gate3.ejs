<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Step - Get Your Link! - FlashURL</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ö° FlashURL</h1>
        </header>

        <main>
            <div class="card redirect-card">
                <div class="step-progress">
                    <div class="step completed">‚úì</div>
                    <div class="step-line completed"></div>
                    <div class="step completed">‚úì</div>
                    <div class="step-line completed"></div>
                    <div class="step active">3</div>
                </div>
                <p class="step-text">Final Step! </p>

                <h2>üéâ Your link is ready!</h2>

                <!-- Banner Ad Top -->
                <div class="ad-container">
                    <div class="ad-box banner-ad">
                        <script>
                            atOptions = {
                                'key' : '3eff8504b33c6f3f2949267088e6b4c3',
                                'format' : 'iframe',
                                'height' : 60,
                                'width' : 468,
                                'params' : {}
                            };
                        </script>
                        <script src="https://www.highperformanceformat.com/3eff8504b33c6f3f2949267088e6b4c3/invoke.js"></script>
                    </div>
                </div>

                <div class="countdown" id="countdownSection">
                    <p>Please wait <span id="timer" class="timer-count">5</span> seconds</p>
                    <div class="progress-bar">
                        <div class="progress" id="progress"></div>
                    </div>
                </div>

                <div id="captchaSection" class="captcha-section hidden">
                    <p>Verify you're human to get your link:</p>
                    <div class="recaptcha-container">
                        <div class="g-recaptcha" 
                             data-sitekey="<%= siteKey %>" 
                             data-callback="onCaptchaSuccess"
                             data-size="normal">
                        </div>
                    </div>
                    <p class="captcha-note">Just click the checkbox! ‚úÖ</p>
                    <p id="captchaError" class="error-text hidden"></p>
                </div>

                <div id="getLinkSection" class="get-link-section hidden">
                    <p class="success-text">‚úÖ Verified! Click below to continue</p>
                    <a href="#" id="getLinkBtn" class="btn btn-success">
                        üîó GET LINK
                    </a>
                </div>

                <div class="destination">
                    <p>Destination:</p>
                    <code><%= originalUrl %></code>
                </div>

                <!-- Banner Ad Bottom -->
                <div class="ad-container">
                    <div class="ad-box banner-ad">
                        <script>
                            atOptions = {
                                'key' : '3eff8504b33c6f3f2949267088e6b4c3',
                                'format' : 'iframe',
                                'height' : 60,
                                'width' : 468,
                                'params' : {}
                            };
                        </script>
                        <script src="https://www.highperformanceformat.com/3eff8504b33c6f3f2949267088e6b4c3/invoke.js"></script>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>¬© 2025 FlashURL.  Made with ‚ù§Ô∏è</p>
        </footer>
    </div>

    <script>
        var timeLeft = 5;
        var timerEl = document.getElementById('timer');
        var progressEl = document.getElementById('progress');
        var countdownSection = document.getElementById('countdownSection');
        var captchaSection = document.getElementById('captchaSection');
        var getLinkSection = document.getElementById('getLinkSection');
        var captchaError = document.getElementById('captchaError');
        var getLinkBtn = document.getElementById('getLinkBtn');
        var shortId = '<%= shortId %>';
        var verifiedUrl = null;

        var countdown = setInterval(function() {
            timeLeft = timeLeft - 1;
            timerEl.textContent = timeLeft;
            progressEl.style.width = ((5 - timeLeft) / 5 * 100) + '%';

            if (timeLeft <= 0) {
                clearInterval(countdown);
                countdownSection.style.display = 'none';
                captchaSection.style.display = 'block';
                captchaSection.classList.remove('hidden');
            }
        }, 1000);

        function onCaptchaSuccess(token) {
            // Verify CAPTCHA on server
            fetch('/verify/' + shortId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ captchaToken: token })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    verifiedUrl = data.redirectUrl;
                    captchaSection.style.display = 'none';
                    getLinkSection.style.display = 'block';
                    getLinkSection.classList.remove('hidden');
                } else {
                    captchaError.textContent = data.error || 'Verification failed. Please try again.';
                    captchaError.classList.remove('hidden');
                    grecaptcha.reset();
                }
            })
            .catch(function(error) {
                captchaError.textContent = 'Network error. Please try again.';
                captchaError.classList.remove('hidden');
                grecaptcha.reset();
            });
        }

        getLinkBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (verifiedUrl) {
                window.location.href = verifiedUrl;
            }
        });
    </script>

    <!-- Ad Blocker Detection -->
    <script src="/js/adblock-detect.js"></script>
    
    <!-- Adsterra Social Bar Ad (bypasses ad blockers) -->
    <script src="https://pl28355881.effectivegatecpm.com/41/b9/68/41b9683409b2e1df660f482f0a40d231.js"></script>
</body>
</html>