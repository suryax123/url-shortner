<![CDATA[<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Final Step — FlashURL</title>
  <link rel="stylesheet" href="/css/style.css" />
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
  <main class="container">
    <section class="card redirect-card" role="main" aria-labelledby="final-title">
      <div class="step-progress" aria-hidden="true">
        <div class="step completed">✓</div>
        <div class="step-line completed"></div>
        <div class="step completed">✓</div>
        <div class="step-line completed"></div>
        <div class="step active">3</div>
      </div>

      <h2 id="final-title">Your link is ready!</h2>
      <p class="step-text">Verify to get your destination link.</p>

      <!-- Banner top -->
      <div class="ad-container banner-top">
        <div id="bannerTop-<%= shortId %>" class="ad-box banner-ad" role="region" aria-label="Advertisement - banner top"></div>
      </div>
      <script>
        (function(){
          var containerId = 'bannerTop-<%= shortId %>';
          function loadTop(){
            if (window.adLoader) {
              window.atOptions = {
                'key' : '3eff8504b33c6f3f2949267088e6b4c3',
                'format' : 'iframe',
                'height' : 60,
                'width' : 320,
                'params' : {}
              };
              adLoader.loadScript('https://www.highperformanceformat.com/3eff8504b33c6f3f2949267088e6b4c3/invoke.js', {timeout:7000, retries:1})
                .catch(function(){ adLoader.showFallback(document.getElementById(containerId)); });
            } else {
              var s = document.createElement('script');
              s.src = '/js/ads-loader.js';
              s.onload = function(){ loadTop(); };
              document.head.appendChild(s);
            }
          }
          loadTop();
        })();
      </script>

      <div class="countdown" id="countdownSection">
        <p>Please wait <span id="timer3" class="timer-count">5</span>s</p>
        <div class="progress-bar"><div id="progress3" class="progress"></div></div>
      </div>

      <div id="captchaSection" class="captcha-section hidden" aria-hidden="true">
        <p>Verify you're human:</p>
        <div class="recaptcha-container">
          <div class="g-recaptcha" data-sitekey="<%= siteKey %>" data-callback="onCaptchaSuccess"></div>
        </div>
        <p id="captchaError" class="error-text hidden"></p>
      </div>

      <div id="getLinkSection" class="get-link-section hidden" aria-hidden="true">
        <p class="success-text">Verified — click to continue</p>
        <a id="getLinkBtn" class="btn btn-success" href="#">Get Link</a>
      </div>

      <!-- Banner bottom -->
      <div class="ad-container banner-bottom">
        <div id="bannerBottom-<%= shortId %>" class="ad-box banner-ad" role="region" aria-label="Advertisement - banner bottom"></div>
      </div>
      <script>
        (function(){
          var containerId = 'bannerBottom-<%= shortId %>';
          function loadBottom(){
            if (window.adLoader) {
              window.atOptions = {
                'key' : '3eff8504b33c6f3f2949267088e6b4c3',
                'format' : 'iframe',
                'height' : 60,
                'width' : 320,
                'params' : {}
              };
              adLoader.loadScript('https://www.highperformanceformat.com/3eff8504b33c6f3f2949267088e6b4c3/invoke.js', {timeout:7000, retries:1})
                .catch(function(){ adLoader.showFallback(document.getElementById(containerId)); });
            } else {
              var s = document.createElement('script');
              s.src = '/js/ads-loader.js';
              s.onload = function(){ loadBottom(); };
              document.head.appendChild(s);
            }
          }
          loadBottom();
        })();
      </script>

      <!-- Social bar -->
      <div id="socialBarContainer-<%= shortId %>" aria-hidden="true"></div>
      <script>
        (function(){
          var containerId = 'socialBarContainer-<%= shortId %>';
          var scriptUrl = 'https://pl28355881.effectivegatecpm.com/41/b9/68/41b9683409b2e1df660f482f0a40d231.js';
          if (window.adLoader) {
            adLoader.loadSocialBar(scriptUrl, containerId, '<div class="social-fallback">Connect</div>');
          } else {
            var s = document.createElement('script');
            s.src = '/js/ads-loader.js';
            s.onload = function(){ adLoader.loadSocialBar(scriptUrl, containerId, '<div class="social-fallback">Connect</div>'); };
            document.head.appendChild(s);
          }
        })();
      </script>

      <div class="destination">
        <p>Destination</p>
        <code><%= originalUrl %></code>
      </div>
    </section>
  </main>

  <footer><p>© 2025 FlashURL</p></footer>

  <script>
    (function(){
      var timeLeft = 5;
      var timer = document.getElementById('timer3');
      var progress = document.getElementById('progress3');
      var countdown = document.getElementById('countdownSection');
      var captchaSection = document.getElementById('captchaSection');
      var getLinkSection = document.getElementById('getLinkSection');
      var captchaError = document.getElementById('captchaError');
      var getLinkBtn = document.getElementById('getLinkBtn');
      var shortId = '<%= shortId %>';
      var verifiedUrl = null;

      function updateProgress() {
        var elapsed = 5 - timeLeft;
        if (progress) progress.style.width = ((elapsed)/5*100) + '%';
      }

      var interval = setInterval(function(){
        timeLeft--;
        if (timer) timer.textContent = timeLeft;
        updateProgress();
        if (timeLeft <= 0) {
          clearInterval(interval);
          if (countdown) countdown.style.display = 'none';
          if (captchaSection) {
            captchaSection.classList.remove('hidden');
            captchaSection.setAttribute('aria-hidden','false');
            captchaSection.style.display = 'block';
          }
        }
      }, 1000);

      window.onCaptchaSuccess = function(token) {
        fetch('/verify/' + shortId, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ captchaToken: token })
        }).then(r => r.json()).then(function(data){
          if (data.success) {
            verifiedUrl = data.redirectUrl;
            captchaSection.style.display = 'none';
            getLinkSection.classList.remove('hidden');
            getLinkSection.setAttribute('aria-hidden','false');
            getLinkSection.style.display = 'block';
          } else {
            if (captchaError) {
              captchaError.textContent = data.error || 'Verification failed';
              captchaError.classList.remove('hidden');
            }
            if (typeof grecaptcha !== 'undefined') grecaptcha.reset();
          }
        }).catch(function(){
          if (captchaError) {
            captchaError.textContent = 'Network error';
            captchaError.classList.remove('hidden');
          }
          if (typeof grecaptcha !== 'undefined') grecaptcha.reset();
        });
      };

      if (getLinkBtn) {
        getLinkBtn.addEventListener('click', function(e){
          e.preventDefault();
          if (verifiedUrl) window.location.href = verifiedUrl;
        });
      }
    })();
  </script>

  <script src="/js/adblock-detect.js"></script>
  <script src="/js/ads-loader.js"></script>
</body>
</html>]]>
